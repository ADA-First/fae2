{% extends "base.html" %}
{% load staticfiles i18n %}
{% load tz %}

{% block title %}
Manage Reports
{% endblock %}

{% block content %}
{% localtime on %}

<section aria-labelledby="id_reports_label">
   <h2 id="id_reports_label" class="sr-only">{{ reports.count }} reports</h2> 

   <table id="id_table_reports" class="details table table-striped table-hover sortable"  aria-labelledby="id_reports_label">
        <thead>
            <tr>
                <th  class="text"><abbr title="Permanent">Perm</abbr></th>
                <th  class="text">Title</th>
                <th  class="text"><abbr title="Date and time of evaluation">Date/Time</abbr></th>
                <th  class="num" >Pages</th>
                <th  class="text">Ruleset</th>
                <th  class="text">URL</th>
                <th  class="num" >Depth</th>
                <th  class="text">Action</th>
            </tr>
        </thead>
        <tbody>
            {% if reports.count %}
            {% for report in reports %}
            <tr>
                <td class="text">
                    <input  id="id_{{report.slug}}" 
                            type="checkbox" 
                            {% if report.archive %}checked{% endif %} 
                            aria-label="Archive {{report.title}}"
                            onclick="checkboxArchiveEvent(event, '{{report.slug}}')"
                            >
                </td>
                
                <td id="id_title_{{forloop.count}}" class="text" style="min-width: 15em;">
                    <a href="{% url 'report_rules' report.slug 'rc' %}">
                    {% if report.title %}
                        {{ report.title }}
                    {% else %}
                        {{ report.url }}
                    {% endif %}
                    </a>
                </td>
                
                <td class="text date">
                    {{ report.created|date:"Y-m-d H:i" }}
                </td>

                <td class="num"> {{ report.page_all_results.count }}</td> 
                
                <td class="text">{{ report.ruleset     }}</td>

                <td class="text">{{ report.url }}</td>
                
                <td class="num"> {{ report.depth                  }}</td>

                <td class="text">
                    <input  id="id_delete_{{report.slug}}" 
                            type="button" 
                            value="Delete"
                            aria-label="Delete: {{report.title}}"
                            onclick="buttonDeleteEvent(event, '{{report.slug}}')"
                            >
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td>No reports available</td>
            </tr>
            {% endif %}
            
        </tbody>
        
    </table>

    <ul class="user_profile">
        <li>Maximum archived reports: <strong>{{user_profile.max_archive}}</strong></li>
        <li>Maximum permanent reports: <strong>{{user_profile.max_permanent}}</strong></li>
    </ul>
</section>

{% if old_reports.count %}

<section aria-labelledby="id_other_reports_label" style="margin-top: 4em;">
    <h2 id="id_other_reports_label">Old Reports</h2> 
    <p>Old reports will be automatically deleted within the next 24 hours unless you add it to your group of permanent reports.  
   <table id="id_table_other_reports" class="details table table-striped table-hover sortable"  aria-labelledby="id_other_reports_label">
        <thead>
            <tr>
                <th  class="text"><abbr title="Permanent">Perm</abbr></th>
                <th  class="text">Title</th>
                <th  class="text"><abbr title="Date and time of evaluation">Date/Time</abbr></th>
                <th  class="num" >Pages</th>
                <th  class="text">Ruleset</th>
                <th  class="text">URL</th>
                <th  class="num" >Depth</th>
                <th  class="text">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for report in old_reports.all %}
            <tr>
                <td class="text">
                    <input  id="id_archive_{{report.slug}}" 
                            type="checkbox" 
                            {% if report.archive %}checked{% endif %} 
                            aria-label="Archive {{report.title}}"
                            onclick="checkboxArchiveEvent(event, '{{report.slug}}')"
                            >
                </td>
                
                <td id="id_title_{{forloop.count}}" class="text" style="min-width: 15em;">
                    <a href="{% url 'report_rules' report.slug 'rc' %}">
                    {% if report.title %}
                        {{ report.title }}
                    {% else %}
                        {{ report.url }}
                    {% endif %}
                    </a>
                </td>
                
                <td class="text date">
                    {{ report.created|date:"Y-m-d H:i" }}
                </td>

                <td class="num"> {{ report.page_all_results.count }}</td> 
                
                <td class="text">{{ report.ruleset     }}</td>

                <td class="text">{{ report.url }}</td>
                
                <td class="num"> {{ report.depth                  }}</td>

                <td class="text">
                    <input  id="id_delete_{{report.slug}}" 
                            type="button" 
                            value="Delete"
                            aria-label="Delete: {{report.title}}"
                            onclick="buttonDeleteEvent(event, '{{report.slug}}')"
                            >
                </td>

            </tr>
            {% endfor %}
            
        </tbody>
        
    </table>  
{% endif %}
    
</section>

{% endlocaltime %}

{% endblock %}

{% block javascript %}

<script type="text/javascript">

var report_status_url = "{{site.domain}}/processing/status/all/";

function updateDisabledCheckboxes() {


  function getCheckboxes() {
    var inputs = document.getElementsByTagName('input');

    for(var i = 0; i < inputs.length; i++) {
      var input = inputs[i];
      if (input.type === 'checkbox') {
        checkboxes.push(input);
        if(input.checked) count += 1;
      }  
    }
  }

  var count = 0;
  var checkboxes = [];
  getCheckboxes();

  for(var i=0; i < checkboxes.length; i++) {
    var cb = checkboxes[i];
    if (count >= {{user_profile.max_permanent}}) {
      if (!cb.checked) cb.disabled=true
    }
    else {
      cb.disabled = false;
    }    
  }


};

function checkboxArchiveEvent(event, slug) {

  var url;
  var cb = event.currentTarget;

  if (cb.checked) {
    url = "{{site.domain}}/report/" + slug +"/archive/true/";
  }
  else {
    url = "{{site.domain}}/report/" + slug +"/archive/false/";
  }

  fae2TableUtils.getJSON(url, false);

  updateDisabledCheckboxes();

  event.stopPropagation();

}

function buttonDeleteEvent(event, slug) {

  var url = "{{site.domain}}/report/" + slug + "/delete/";

  location.href=url;

}
</script>

{% endblock %}